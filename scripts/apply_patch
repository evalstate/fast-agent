#!/usr/bin/env python3
import shutil
import subprocess
import sys
import re

def main() -> int:
    data = sys.stdin.read()
    # Strip optional wrapper
    data = re.sub(r"^\s*\*\*\*\s*Begin Patch\s*\n", "", data)
    data = re.sub(r"\n\*\*\*\s*End Patch\s*\s*$", "\n", data)

    if not data.strip():
        print("No patch data on stdin.", file=sys.stderr)
        return 1

    # Prefer git apply if available
    if shutil.which("git"):
        proc = subprocess.run(["git", "apply", "-"], input=data.encode())
        return proc.returncode

    # Fallback to patch
    if shutil.which("patch"):
        proc = subprocess.run(["patch", "-p0"], input=data.encode())
        return proc.returncode

    print("Neither git nor patch is available.", file=sys.stderr)
    return 1

if __name__ == "__main__":
    raise SystemExit(main())
